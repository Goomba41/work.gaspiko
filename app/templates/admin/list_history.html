{% extends "admin/base_admin.html" %}
{% block content %}

{% if session['logged_in'] %}

    {% from "admin/_formhelpers.html" import flash_msg %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {{flash_msg(messages)}}
        {% endif %}
    {% endwith %}

    <div class="col-sm-9">
        {{ pagination.links }}
        <table class="table table-striped table-bordered table-hover model-list" >
            <tr>
                <th>ID</th>
                <th>Действие</th>
                <th>Дата</th>
            </tr>
            {% for action in actions_all.items %}
                <tr>
                    <td>{{ action.id }}</td>
                    <td>Пользователь <span class="label label-info">{{ action.user_parent.surname }} {{ action.user_parent.name }}</span> произвел <span class="label label-info">{{ action.action }}</span> в таблице <span class="label label-info">{{ action.table_parent.name }}</span> модуля <span class="label label-info">{{ action.table_parent.module_parent.name }}</span></td>
                    <td>{{ action.cdate }}</td>
                </tr>
            {% endfor %}
        </table>
        {{ pagination.links }}
    </div>
    <div class="col-sm-3">
        <div id="frequently_table" ></div>
        <div id="frequently_operation" ></div>
        <div id="users_activity" ></div>
    </div>
    <br style="clear: both;"/>

    <script type="text/javascript">

        $(document).ready(function () {

            // Build the chart
            Highcharts.chart('frequently_table', {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: 'Наиболее часто используемая таблица'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Частота',
                    colorByPoint: true,
                    data: {{ response|safe }}
                }]
            });

            Highcharts.chart('frequently_operation', {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: 'Наиболее часто выполняемая операция'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Частота',
                    colorByPoint: true,
                    data: {{ response2|safe }}
                }]
            });

            Highcharts.chart('users_activity', {
                chart: {
                    plotBackgroundColor: null,
                    plotBorderWidth: null,
                    plotShadow: false,
                    type: 'pie'
                },
                title: {
                    text: 'Наиболее активные пользователи'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false
                        },
                        showInLegend: true
                    }
                },
                series: [{
                    name: 'Частота',
                    colorByPoint: true,
                    data: {{ response3|safe }}
                }]
            });
        });
    </script>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {{flash_msg(messages)}}
        {% endif %}
    {% endwith %}

    <br style="clear: both;"/>
{% endif %}

{% endblock %}
